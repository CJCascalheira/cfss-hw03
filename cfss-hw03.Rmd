---
title: "CFSS Homework 03"
author: "Cory J. Cascalheira"
date: "December 21, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Part 1
___
Load dependencies.

```{r message=FALSE}
library(tidyverse)
library(readxl)
```

Set the default theme for `ggplot2`.

```{r}
theme_set(theme_minimal())
```

Load the data.

```{r}
load("J:/sample_data/dadmom.rda")
dadmom
```

Tidy the data frame.

```{r}
# Tidy parents and names
(parents <- dadmom %>%
  # Remove income columns
  select(-starts_with("inc")) %>%
  # Gather except family ID
  gather(key = parent, value = name, -famid) %>%
  # Make parent variable make more sense
  mutate(parent = fct_recode(factor(parent), "father" = "named", "mother" = "namem"))
)

# Tidy the income, make sure order matches parents
(income <- dadmom %>%
  # Remove name columns
  select(-starts_with("name")) %>%
  # Gather except family ID
  gather(key = parent, value = income, -famid) %>%
  # Drop family ID and parent columns
  select(income)
)

# Bind columns
(dadmom_new <- bind_cols(parents, income)
)
```

# Part 2
___
Load the data.

```{r}
library(gapminder)
hiv <- read_excel("J:/sample_data/hiv-prevalence.xlsx")
hiv
```

Fix the country column.

```{r}
colnames(hiv)[1] <- "country"
```

Are the same countries in both datasets?

```{r}
# Which countries are in the gapminder dataset
gapminder_names <- unique(as.character(gapminder$country))

# Filter the HIV dataset to include only those countries in gapminder
(hiv2 <- hiv %>%
  filter(country %in% gapminder_names)
)
```

Tidy the HIV data frame.

```{r}
(hiv3 <- hiv2 %>%
  gather(key = year, value = hiv_prevalence, -country)
)
```

Transform year variable into an integer and HIV prevalence into a numeric.

```{r}
hiv3$year <- as.integer(hiv3$year)
hiv3$hiv_prevalence <- as.numeric(hiv3$hiv_prevalence)

# Verify change
head(hiv3)
```

## HIV Prevalence & Life Expectancy

I will use a `left_join()` to keep all original columns and observations from `gapminder`, effectively appending the HIV prevalence variable to the dataset.

```{r}
(gap_hiv <- left_join(gapminder, hiv3, by = c("country", "year")))
```

What is the relationship between HIV prevalence and life expectancy?

```{r}
# Filter out missing values
gap_hiv_complete <- gap_hiv %>%
  filter(!is.na(hiv_prevalence))

# Simple linear model
lm(lifeExp ~ hiv_prevalence, data = gap_hiv_complete)
```

There is a negative relationship between life expectancy and HIV prevalence. For each 1% increase of infection in the adult population, the life expectancy decreases by an average of 1.42 years.

```{r fig.height=7, fig.width=7, message=FALSE}
gap_hiv_complete %>%
  # Add continent for more detail
  ggplot(aes(x = hiv_prevalence, y = lifeExp, color = continent)) +
  geom_point(size = 2, alpha = 0.5) +
  # Prevent color aesthetic from inheriting
  geom_smooth(aes(color = NULL), se = FALSE, color = "cadetblue", size = 2) +
  # Provide nice labels
  labs(title = "Life Expectancy Predicted by HIV Infection Rate Among Adults",
       caption = "Source: Gapminder",
       x = "HIV Prevalence",
       y = "Life Expectancy",
       color = "Continent") +
  # Add custom colors
  scale_color_brewer(type = "qual", palette = "Paired") +
  # Move legend
  theme(legend.position = "top")
```

The trend is negative and drops sharply.

## Continents with NA

```{r}
gap_hiv %>%
  group_by(continent) %>%
  # Count missing values
  count(is.na(hiv_prevalence)) %>%
  # Clean column name
  rename("missing" = "is.na(hiv_prevalence)") %>%
  # Filter out non-missing values
  filter(missing == TRUE) %>%
  # Bar chart of results
  
```

Alarmingly, even though African countries have the most cases of HIV, the dataset is least complete on the African continent. The HIV epidemic is likely more widespread than the data suggest.

# Part 3
___
